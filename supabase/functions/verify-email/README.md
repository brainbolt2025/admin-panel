# Verify Email Edge Function

This Supabase Edge Function handles email verification when users click the verification link sent via email.

## Features

- ✅ Verifies email tokens from verification links
- ✅ Updates `email_verified` status in users table
- ✅ Clears verification token after successful verification
- ✅ Updates Supabase Auth email confirmation status
- ✅ Handles already-verified emails gracefully
- ✅ Returns clear success/error messages

## Setup

### 1. Database Schema

Run this SQL migration in your Supabase SQL Editor:

```sql
-- Add email verification columns to users table
ALTER TABLE users 
ADD COLUMN IF NOT EXISTS verification_token TEXT,
ADD COLUMN IF NOT EXISTS email_verified BOOLEAN DEFAULT false,
ADD COLUMN IF NOT EXISTS verification_token_expires_at TIMESTAMPTZ;

-- Create index on verification_token for faster lookups
CREATE INDEX IF NOT EXISTS idx_users_verification_token 
ON users(verification_token) 
WHERE verification_token IS NOT NULL;
```

**Or run the migration file:**
```
add-email-verification-columns.sql
```

### 2. Ensure Token Storage is Enabled

In `stripe-webhook/index.ts`, make sure the token storage code is **uncommented** (it should be by default now):

```typescript
await supabaseAdmin
  .from('users')
  .update({ 
    verification_token: verificationToken,
    verification_token_expires_at: new Date(Date.now() + 24 * 60 * 60 * 1000).toISOString()
  })
  .eq('id', user_id)
```

## Deployment

```bash
# Deploy WITHOUT JWT verification (users aren't logged in yet)
supabase functions deploy verify-email --no-verify-jwt
```

**Important:** This function MUST be deployed with `--no-verify-jwt` because users clicking verification links are not authenticated yet. The verification token itself provides the security.

## Usage

### How It Works

1. User receives verification email with link: `${BASE_URL}/verify?token=${token}`
2. User clicks link → Frontend redirects to login page with `?token=xxx`
3. `Login.tsx` component detects token and calls this function
4. Function verifies token, updates user record, and returns success/error

### Frontend Integration

The `Login.tsx` component already handles verification automatically:

```typescript
// When user clicks verification link, Login component:
// 1. Extracts token from URL: ?token=xxx
// 2. Calls verify-email function
// 3. Shows success/error message
```

### Manual API Call

You can also call it directly:

```typescript
const response = await fetch(
  `${config.supabase.url}/functions/v1/verify-email?token=${token}`,
  {
    method: 'GET',
    headers: {
      'Content-Type': 'application/json',
      'apikey': config.supabase.anonKey,
    }
  }
);

const data = await response.json();
```

## Response Format

### Success (200)
```json
{
  "success": true,
  "message": "Email verified successfully! You can now sign in.",
  "user_id": "uuid-here"
}
```

### Already Verified (200)
```json
{
  "success": true,
  "message": "Email already verified. You can sign in now.",
  "already_verified": true
}
```

### Error (400/500)
```json
{
  "success": false,
  "error": "Invalid or expired verification token. Please request a new verification email."
}
```

## Error Handling

The function handles:
- ✅ Missing tokens → Returns 400 with clear error
- ✅ Invalid/expired tokens → Returns 400
- ✅ Already verified emails → Returns 200 with `already_verified: true`
- ✅ Database errors → Returns 500
- ✅ Auth update errors → Logs warning but doesn't fail

## Security Notes

- Tokens are UUIDs generated by `crypto.randomUUID()` (secure)
- Tokens are cleared after verification
- Tokens can optionally expire after 24 hours
- No authentication required for this endpoint (tokens are the auth)

## Related Functions

- **send-verification-email**: Sends the verification email
- **stripe-webhook**: Triggers email sending after payment success

## Testing

1. Complete a subscription payment (triggers webhook)
2. Check email for verification link
3. Click link (redirects to login with token)
4. Should see "Email verified successfully!" message
5. Try clicking link again → Should see "already verified" message

